import { useEffect, useState } from 'react';

type FacingDirection = 'north' | 'south' | 'east' | 'west';

interface PixelCharacterProps {
  direction: FacingDirection;
  isMoving: boolean;
  size: number;
  userColor: string;
}

const PixelCharacter = ({ direction, isMoving, size, userColor }: PixelCharacterProps) => {
  const [frame, setFrame] = useState(0);

  // Animation loop when moving
  useEffect(() => {
    if (!isMoving) {
      setFrame(0);
      return;
    }

    const interval = setInterval(() => {
      setFrame(prev => (prev + 1) % 4);
    }, 150);

    return () => clearInterval(interval);
  }, [isMoving]);

  // Scale factor based on tile size
  const scale = Math.max(0.5, size / 28);
  const pixelSize = Math.max(1, Math.floor(2 * scale));

  // Character pixel art data - each direction has 4 frames
  // 0 = transparent, 1 = skin, 2 = hair, 3 = shirt (user color), 4 = pants, 5 = outline, 6 = eyes
  const sprites: Record<FacingDirection, number[][][]> = {
    south: [
      // Frame 0 - standing
      [
        [0,0,2,2,2,2,0,0],
        [0,2,2,2,2,2,2,0],
        [0,1,6,1,1,6,1,0],
        [0,1,1,1,1,1,1,0],
        [0,0,1,1,1,1,0,0],
        [0,3,3,3,3,3,3,0],
        [0,3,3,3,3,3,3,0],
        [1,3,3,3,3,3,3,1],
        [0,4,4,0,0,4,4,0],
        [0,4,4,0,0,4,4,0],
        [0,5,5,0,0,5,5,0],
      ],
      // Frame 1 - walk left leg forward
      [
        [0,0,2,2,2,2,0,0],
        [0,2,2,2,2,2,2,0],
        [0,1,6,1,1,6,1,0],
        [0,1,1,1,1,1,1,0],
        [0,0,1,1,1,1,0,0],
        [0,3,3,3,3,3,3,0],
        [0,3,3,3,3,3,3,0],
        [1,3,3,3,3,3,3,1],
        [0,0,4,4,4,4,0,0],
        [0,4,4,0,0,4,4,0],
        [0,5,5,0,0,0,5,0],
      ],
      // Frame 2 - standing
      [
        [0,0,2,2,2,2,0,0],
        [0,2,2,2,2,2,2,0],
        [0,1,6,1,1,6,1,0],
        [0,1,1,1,1,1,1,0],
        [0,0,1,1,1,1,0,0],
        [0,3,3,3,3,3,3,0],
        [0,3,3,3,3,3,3,0],
        [1,3,3,3,3,3,3,1],
        [0,4,4,0,0,4,4,0],
        [0,4,4,0,0,4,4,0],
        [0,5,5,0,0,5,5,0],
      ],
      // Frame 3 - walk right leg forward
      [
        [0,0,2,2,2,2,0,0],
        [0,2,2,2,2,2,2,0],
        [0,1,6,1,1,6,1,0],
        [0,1,1,1,1,1,1,0],
        [0,0,1,1,1,1,0,0],
        [0,3,3,3,3,3,3,0],
        [0,3,3,3,3,3,3,0],
        [1,3,3,3,3,3,3,1],
        [0,0,4,4,4,4,0,0],
        [0,4,4,0,0,4,4,0],
        [0,5,0,0,0,5,5,0],
      ],
    ],
    north: [
      // Frame 0 - standing (back view)
      [
        [0,0,2,2,2,2,0,0],
        [0,2,2,2,2,2,2,0],
        [0,2,2,2,2,2,2,0],
        [0,1,1,1,1,1,1,0],
        [0,0,1,1,1,1,0,0],
        [0,3,3,3,3,3,3,0],
        [0,3,3,3,3,3,3,0],
        [1,3,3,3,3,3,3,1],
        [0,4,4,0,0,4,4,0],
        [0,4,4,0,0,4,4,0],
        [0,5,5,0,0,5,5,0],
      ],
      // Frame 1
      [
        [0,0,2,2,2,2,0,0],
        [0,2,2,2,2,2,2,0],
        [0,2,2,2,2,2,2,0],
        [0,1,1,1,1,1,1,0],
        [0,0,1,1,1,1,0,0],
        [0,3,3,3,3,3,3,0],
        [0,3,3,3,3,3,3,0],
        [1,3,3,3,3,3,3,1],
        [0,0,4,4,4,4,0,0],
        [0,4,4,0,0,4,4,0],
        [0,5,5,0,0,0,5,0],
      ],
      // Frame 2
      [
        [0,0,2,2,2,2,0,0],
        [0,2,2,2,2,2,2,0],
        [0,2,2,2,2,2,2,0],
        [0,1,1,1,1,1,1,0],
        [0,0,1,1,1,1,0,0],
        [0,3,3,3,3,3,3,0],
        [0,3,3,3,3,3,3,0],
        [1,3,3,3,3,3,3,1],
        [0,4,4,0,0,4,4,0],
        [0,4,4,0,0,4,4,0],
        [0,5,5,0,0,5,5,0],
      ],
      // Frame 3
      [
        [0,0,2,2,2,2,0,0],
        [0,2,2,2,2,2,2,0],
        [0,2,2,2,2,2,2,0],
        [0,1,1,1,1,1,1,0],
        [0,0,1,1,1,1,0,0],
        [0,3,3,3,3,3,3,0],
        [0,3,3,3,3,3,3,0],
        [1,3,3,3,3,3,3,1],
        [0,0,4,4,4,4,0,0],
        [0,4,4,0,0,4,4,0],
        [0,5,0,0,0,5,5,0],
      ],
    ],
    east: [
      // Frame 0 - standing (right view)
      [
        [0,0,2,2,2,0,0,0],
        [0,2,2,2,2,2,0,0],
        [0,1,1,1,6,1,0,0],
        [0,1,1,1,1,1,0,0],
        [0,0,1,1,1,0,0,0],
        [0,3,3,3,3,3,0,0],
        [1,3,3,3,3,3,0,0],
        [0,3,3,3,3,0,1,0],
        [0,0,4,4,4,0,0,0],
        [0,0,4,4,4,0,0,0],
        [0,0,5,5,5,0,0,0],
      ],
      // Frame 1
      [
        [0,0,2,2,2,0,0,0],
        [0,2,2,2,2,2,0,0],
        [0,1,1,1,6,1,0,0],
        [0,1,1,1,1,1,0,0],
        [0,0,1,1,1,0,0,0],
        [0,3,3,3,3,3,0,0],
        [1,3,3,3,3,3,0,0],
        [0,3,3,3,3,0,1,0],
        [0,4,4,0,4,4,0,0],
        [0,5,0,0,0,5,0,0],
        [0,0,0,0,0,0,0,0],
      ],
      // Frame 2
      [
        [0,0,2,2,2,0,0,0],
        [0,2,2,2,2,2,0,0],
        [0,1,1,1,6,1,0,0],
        [0,1,1,1,1,1,0,0],
        [0,0,1,1,1,0,0,0],
        [0,3,3,3,3,3,0,0],
        [1,3,3,3,3,3,0,0],
        [0,3,3,3,3,0,1,0],
        [0,0,4,4,4,0,0,0],
        [0,0,4,4,4,0,0,0],
        [0,0,5,5,5,0,0,0],
      ],
      // Frame 3
      [
        [0,0,2,2,2,0,0,0],
        [0,2,2,2,2,2,0,0],
        [0,1,1,1,6,1,0,0],
        [0,1,1,1,1,1,0,0],
        [0,0,1,1,1,0,0,0],
        [0,3,3,3,3,3,0,0],
        [1,3,3,3,3,3,0,0],
        [0,3,3,3,3,0,1,0],
        [0,4,4,0,4,4,0,0],
        [0,0,5,0,5,0,0,0],
        [0,0,0,0,0,0,0,0],
      ],
    ],
    west: [
      // Frame 0 - standing (left view) - mirrored from east
      [
        [0,0,0,2,2,2,0,0],
        [0,0,2,2,2,2,2,0],
        [0,0,1,6,1,1,1,0],
        [0,0,1,1,1,1,1,0],
        [0,0,0,1,1,1,0,0],
        [0,0,3,3,3,3,3,0],
        [0,0,3,3,3,3,3,1],
        [0,1,0,3,3,3,3,0],
        [0,0,0,4,4,4,0,0],
        [0,0,0,4,4,4,0,0],
        [0,0,0,5,5,5,0,0],
      ],
      // Frame 1
      [
        [0,0,0,2,2,2,0,0],
        [0,0,2,2,2,2,2,0],
        [0,0,1,6,1,1,1,0],
        [0,0,1,1,1,1,1,0],
        [0,0,0,1,1,1,0,0],
        [0,0,3,3,3,3,3,0],
        [0,0,3,3,3,3,3,1],
        [0,1,0,3,3,3,3,0],
        [0,0,4,4,0,4,4,0],
        [0,0,5,0,0,0,5,0],
        [0,0,0,0,0,0,0,0],
      ],
      // Frame 2
      [
        [0,0,0,2,2,2,0,0],
        [0,0,2,2,2,2,2,0],
        [0,0,1,6,1,1,1,0],
        [0,0,1,1,1,1,1,0],
        [0,0,0,1,1,1,0,0],
        [0,0,3,3,3,3,3,0],
        [0,0,3,3,3,3,3,1],
        [0,1,0,3,3,3,3,0],
        [0,0,0,4,4,4,0,0],
        [0,0,0,4,4,4,0,0],
        [0,0,0,5,5,5,0,0],
      ],
      // Frame 3
      [
        [0,0,0,2,2,2,0,0],
        [0,0,2,2,2,2,2,0],
        [0,0,1,6,1,1,1,0],
        [0,0,1,1,1,1,1,0],
        [0,0,0,1,1,1,0,0],
        [0,0,3,3,3,3,3,0],
        [0,0,3,3,3,3,3,1],
        [0,1,0,3,3,3,3,0],
        [0,0,4,4,0,4,4,0],
        [0,0,0,5,0,5,0,0],
        [0,0,0,0,0,0,0,0],
      ],
    ],
  };

  const currentSprite = sprites[direction][frame];
  
  const colors: Record<number, string> = {
    0: 'transparent',
    1: '#f5d0a9', // skin
    2: '#5c3d2e', // hair (brown)
    3: userColor, // shirt (user color)
    4: '#3b5998', // pants (blue jeans)
    5: '#2d1f1a', // outline/shoes
    6: '#1a1a1a', // eyes
  };

  return (
    <div 
      className="relative drop-shadow-lg"
      style={{ 
        width: size,
        height: size,
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
      }}
    >
      <svg 
        width={8 * pixelSize} 
        height={11 * pixelSize}
        style={{ imageRendering: 'pixelated' }}
      >
        {currentSprite.map((row, y) =>
          row.map((pixel, x) => (
            pixel !== 0 && (
              <rect
                key={`${x}-${y}`}
                x={x * pixelSize}
                y={y * pixelSize}
                width={pixelSize}
                height={pixelSize}
                fill={colors[pixel]}
              />
            )
          ))
        )}
      </svg>
    </div>
  );
};

export default PixelCharacter;